name: CalDAV åŒæ­¥å’Œ GitHub Pages éƒ¨ç½²

on:
  # å®šæ—¶æ‰§è¡Œ - æ¯å¤©æ—©ä¸Š8ç‚¹å’Œæ™šä¸Š8ç‚¹ï¼ˆåŒ—äº¬æ—¶é—´ï¼‰
  schedule:
    - cron: '0 0 * * *'    # UTC 00:00 = åŒ—äº¬æ—¶é—´ 08:00
    - cron: '0 12 * * *'   # UTC 12:00 = åŒ—äº¬æ—¶é—´ 20:00

  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      sync_type:
        description: 'åŒæ­¥ç±»å‹'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - dingtalk
          - tencent
      cleanup_days:
        description: 'æ¸…ç†å¤šå°‘å¤©å‰çš„ä¸´æ—¶æ–‡ä»¶'
        required: false
        default: '7'
        type: string

  # æ¨é€åˆ°mainåˆ†æ”¯æ—¶è§¦å‘ï¼ˆä»…ç”¨äºæµ‹è¯•å·¥ä½œæµï¼‰
  push:
    branches: [ main ]
    paths:
      - '.github/workflows/**'
      - '*.py'
      - 'requirements.txt'

jobs:
  sync-and-deploy:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      pages: write
      id-token: write

    environment:
      name: Prod
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½® Python ç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        cache: 'pip'

    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: åˆ›å»ºç¯å¢ƒé…ç½®æ–‡ä»¶
      run: |
        cat > .env << EOF
        # å…¨å±€è®¾ç½®
        OUTPUT_DIR=calendar_events
        TIMEOUT=30

        # é’‰é’‰è´¦å·é…ç½®
        DINGTALK_ACCOUNT_NAME=${{ secrets.DINGTALK_ACCOUNT_NAME }}
        DINGTALK_USERNAME=${{ secrets.DINGTALK_USERNAME }}
        DINGTALK_PASSWORD=${{ secrets.DINGTALK_PASSWORD }}
        DINGTALK_URL=${{ secrets.DINGTALK_URL }}

        # è…¾è®¯ä¼šè®®è´¦å·é…ç½®
        TENCENT_ACCOUNT_NAME=${{ secrets.TENCENT_ACCOUNT_NAME }}
        TENCENT_USERNAME=${{ secrets.TENCENT_USERNAME }}
        TENCENT_PASSWORD=${{ secrets.TENCENT_PASSWORD }}
        TENCENT_URL=${{ secrets.TENCENT_URL }}
        EOF

    - name: åˆ—å‡ºé…ç½®çš„è´¦å·
      run: |
        echo "=== æ£€æŸ¥è´¦å·é…ç½® ==="
        python main.py --list

    - name: æ‰§è¡Œæ—¥å†åŒæ­¥
      run: |
        echo "=== å¼€å§‹æ—¥å†åŒæ­¥ ==="
        if [ "${{ github.event.inputs.sync_type }}" = "dingtalk" ]; then
          echo "åŒæ­¥é’‰é’‰è´¦å·..."
          python main.py --sync-type dingtalk
        elif [ "${{ github.event.inputs.sync_type }}" = "tencent" ]; then
          echo "åŒæ­¥è…¾è®¯ä¼šè®®è´¦å·..."
          python main.py --sync-type tencent
        else
          echo "åŒæ­¥æ‰€æœ‰è´¦å·..."
          python main.py --sync-all
        fi

    - name: åˆå¹¶ICSæ–‡ä»¶
      run: |
        echo "=== å¼€å§‹åˆå¹¶ICSæ–‡ä»¶ ==="
        # æŒ‰ç±»å‹åˆå¹¶
        python main.py --merge-type dingtalk || echo "é’‰é’‰åˆå¹¶å¤±è´¥æˆ–æ— æ•°æ®"
        python main.py --merge-type tencent || echo "è…¾è®¯ä¼šè®®åˆå¹¶å¤±è´¥æˆ–æ— æ•°æ®"

        # å…¨å±€åˆå¹¶
        python main.py --merge-all

    - name: æ¸…ç†ä¸´æ—¶æ–‡ä»¶
      run: |
        echo "=== æ¸…ç†ä¸´æ—¶æ–‡ä»¶ ==="
        CLEANUP_DAYS="${{ github.event.inputs.cleanup_days }}"
        if [ -z "$CLEANUP_DAYS" ]; then
          CLEANUP_DAYS=7
        fi
        python main.py --cleanup $CLEANUP_DAYS

    - name: æ£€æŸ¥ç”Ÿæˆçš„æ–‡ä»¶
      run: |
        echo "=== æ£€æŸ¥ç”Ÿæˆçš„æ–‡ä»¶ ==="
        echo "Public ç›®å½•å†…å®¹:"
        ls -la public/ || echo "public ç›®å½•ä¸ºç©ºæˆ–ä¸å­˜åœ¨"

        echo "Merged ç›®å½•å†…å®¹:"
        ls -la merged/ || echo "merged ç›®å½•ä¸ºç©ºæˆ–ä¸å­˜åœ¨"

        echo "äº‹ä»¶ç›®å½•:"
        ls -la *_events_* || echo "æ²¡æœ‰äº‹ä»¶ç›®å½•"

    - name: å‡†å¤‡ GitHub Pages å†…å®¹
      run: |
        echo "=== å‡†å¤‡ GitHub Pages å†…å®¹ ==="

        # åˆ›å»º GitHub Pages æ ¹ç›®å½•
        mkdir -p _site

        # å¤åˆ¶ public ç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶åˆ° _site
        if [ -d "public" ] && [ "$(ls -A public)" ]; then
          cp -r public/* _site/
          echo "å·²å¤åˆ¶ public ç›®å½•å†…å®¹åˆ° _site"
        else
          echo "public ç›®å½•ä¸ºç©ºï¼Œåˆ›å»ºé»˜è®¤é¡µé¢"
          echo "<h1>CalDAV åŒæ­¥å·¥å…·</h1><p>æš‚æ— æ—¥å†æ•°æ®</p>" > _site/index.html
        fi

        # å¤åˆ¶ merged ç›®å½•åˆ° _site/mergedï¼ˆå¯é€‰ï¼‰
        if [ -d "merged" ] && [ "$(ls -A merged)" ]; then
          mkdir -p _site/merged
          cp -r merged/* _site/merged/
          echo "å·²å¤åˆ¶ merged ç›®å½•å†…å®¹"
        fi

        # åˆ›å»ºç®€å•çš„ç´¢å¼•é¡µé¢
        cat > _site/index.html << 'EOF'
        <!DOCTYPE html>
        <html lang="zh-CN">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>CalDAV åŒæ­¥å·¥å…· - æ—¥å†æ–‡ä»¶</title>
            <style>
                body { font-family: Arial, sans-serif; margin: 40px; }
                .container { max-width: 800px; margin: 0 auto; }
                .file-list { list-style: none; padding: 0; }
                .file-list li { margin: 10px 0; padding: 10px; background: #f5f5f5; border-radius: 5px; }
                .file-list a { text-decoration: none; color: #0066cc; font-weight: bold; }
                .file-list a:hover { text-decoration: underline; }
                .timestamp { color: #666; font-size: 0.9em; }
                .description { color: #333; margin-top: 5px; }
            </style>
        </head>
        <body>
            <div class="container">
                <h1>ğŸ“… CalDAV åŒæ­¥å·¥å…· - æ—¥å†æ–‡ä»¶</h1>
                <p>è¿™é‡Œæ˜¯è‡ªåŠ¨åŒæ­¥çš„æ—¥å†æ–‡ä»¶ï¼ŒåŒ…å«é’‰é’‰å’Œè…¾è®¯ä¼šè®®çš„æ—¥å†æ•°æ®ã€‚</p>

                <h2>ğŸŒ åˆå¹¶æ—¥å†æ–‡ä»¶</h2>
                <ul class="file-list" id="calendar-files">
                    <!-- æ–‡ä»¶åˆ—è¡¨å°†é€šè¿‡ JavaScript åŠ¨æ€ç”Ÿæˆ -->
                </ul>

                <h2>ğŸ“‹ æŒ‰ç±»å‹åˆ†ç±»çš„æ—¥å†æ–‡ä»¶</h2>
                <ul class="file-list" id="merged-files">
                    <!-- åˆ†ç±»æ–‡ä»¶åˆ—è¡¨å°†é€šè¿‡ JavaScript åŠ¨æ€ç”Ÿæˆ -->
                </ul>

                <div class="timestamp">
                    <p>æœ€åæ›´æ–°æ—¶é—´: <span id="update-time"></span></p>
                    <p>ç”± GitHub Actions è‡ªåŠ¨ç”Ÿæˆ</p>
                </div>
            </div>

            <script>
                // è®¾ç½®æ›´æ–°æ—¶é—´
                document.getElementById('update-time').textContent = new Date().toLocaleString('zh-CN');

                // åŠ¨æ€åŠ è½½æ–‡ä»¶åˆ—è¡¨
                async function loadFileList() {
                    try {
                        // è·å–å½“å‰ç›®å½•ä¸‹çš„ .ics æ–‡ä»¶
                        const calendarFiles = document.getElementById('calendar-files');
                        const mergedFiles = document.getElementById('merged-files');

                        // è¿™é‡Œå¯ä»¥æ ¹æ®å®é™…ç”Ÿæˆçš„æ–‡ä»¶åæ¥æ›´æ–°
                        // ç”±äºæ˜¯é™æ€é¡µé¢ï¼Œæˆ‘ä»¬ä½¿ç”¨é¢„å®šä¹‰çš„æ¨¡å¼

                        // æ£€æŸ¥æ˜¯å¦æœ‰å…¨å±€åˆå¹¶æ–‡ä»¶
                        const response = await fetch('./');
                        const text = await response.text();

                        // ç®€å•çš„æ–‡ä»¶æ£€æµ‹ï¼ˆå®é™…éƒ¨ç½²æ—¶å¯èƒ½éœ€è¦æ›´å¤æ‚çš„é€»è¾‘ï¼‰
                        if (text.includes('all_calendars_')) {
                            const matches = text.match(/all_calendars_\d{8}_\d{6}\.ics/g);
                            if (matches) {
                                matches.forEach(filename => {
                                    const li = document.createElement('li');
                                    li.innerHTML = `
                                        <a href="./${filename}" download>${filename}</a>
                                        <div class="description">åŒ…å«æ‰€æœ‰è´¦å·çš„åˆå¹¶æ—¥å†æ•°æ®</div>
                                    `;
                                    calendarFiles.appendChild(li);
                                });
                            }
                        }

                    } catch (error) {
                        console.log('æ— æ³•åŠ¨æ€åŠ è½½æ–‡ä»¶åˆ—è¡¨ï¼Œä½¿ç”¨é™æ€å†…å®¹');
                        document.getElementById('calendar-files').innerHTML =
                            '<li>è¯·æ£€æŸ¥æ˜¯å¦æœ‰ .ics æ–‡ä»¶ç”Ÿæˆ</li>';
                    }
                }

                // é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œ
                document.addEventListener('DOMContentLoaded', loadFileList);
            </script>
        </body>
        </html>
        EOF

        echo "GitHub Pages å†…å®¹å‡†å¤‡å®Œæˆ"
        ls -la _site/

    - name: è®¾ç½® GitHub Pages
      uses: actions/configure-pages@v5

    - name: ä¸Šä¼  GitHub Pages å†…å®¹
      uses: actions/upload-pages-artifact@v3
      with:
        path: '_site'

    - name: éƒ¨ç½²åˆ° GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4

    - name: è¾“å‡ºéƒ¨ç½²ç»“æœ
      run: |
        echo "=== éƒ¨ç½²å®Œæˆ ==="
        echo "GitHub Pages URL: ${{ steps.deployment.outputs.page_url }}"
        echo "éƒ¨ç½²çŠ¶æ€: æˆåŠŸ"

        # æ˜¾ç¤ºæœ€ç»ˆçš„æ–‡ä»¶ç»Ÿè®¡
        echo "=== æ–‡ä»¶ç»Ÿè®¡ ==="
        echo "Public æ–‡ä»¶æ•°é‡: $(find _site -name '*.ics' | wc -l)"
        echo "æ€»æ–‡ä»¶å¤§å°: $(du -sh _site | cut -f1)"
