name: CalDAV åŒæ­¥å’Œ GitHub Pages éƒ¨ç½²

on:
  # æ¯15åˆ†é’Ÿè¿è¡Œä¸€æ¬¡
  schedule:
    - cron: '*/15 * * * *'

  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      sync_type:
        description: 'åŒæ­¥ç±»å‹'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - dingtalk
          - tencent
      cleanup_days:
        description: 'æ¸…ç†å¤šå°‘å¤©å‰çš„ä¸´æ—¶æ–‡ä»¶'
        required: false
        default: '7'
        type: string

  # æ¨é€åˆ°mainåˆ†æ”¯æ—¶è§¦å‘ï¼ˆä»…ç”¨äºæµ‹è¯•å·¥ä½œæµï¼‰
  push:
    branches: [ main ]
    paths:
      - '.github/workflows/**'
      - '*.py'
      - 'requirements.txt'

jobs:
  sync-and-deploy:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      pages: write
      id-token: write

    environment:
      name: Prod
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½® Python ç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        cache: 'pip'

    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: åˆ›å»ºç¯å¢ƒé…ç½®æ–‡ä»¶
      run: |
        cat > .env << EOF
        # å…¨å±€è®¾ç½®
        OUTPUT_DIR=calendar_events
        TIMEOUT=30

        # ICS æ–‡ä»¶è‡ªå®šä¹‰åç§°
        ICS_FILE_NAME=${{ secrets.ICS_FILE_NAME || 'latest' }}

        # é’‰é’‰è´¦å·é…ç½®
        DINGTALK_ACCOUNT_NAME=${{ secrets.DINGTALK_ACCOUNT_NAME }}
        DINGTALK_USERNAME=${{ secrets.DINGTALK_USERNAME }}
        DINGTALK_PASSWORD=${{ secrets.DINGTALK_PASSWORD }}
        DINGTALK_URL=${{ secrets.DINGTALK_URL }}
        DINGTALK_SYNC_DAYS_PAST=${{ secrets.DINGTALK_SYNC_DAYS_PAST || 90 }}
        DINGTALK_SYNC_DAYS_FUTURE=${{ secrets.DINGTALK_SYNC_DAYS_FUTURE || 90 }}

        # è…¾è®¯ä¼šè®®è´¦å·é…ç½®
        TENCENT_ACCOUNT_NAME=${{ secrets.TENCENT_ACCOUNT_NAME }}
        TENCENT_USERNAME=${{ secrets.TENCENT_USERNAME }}
        TENCENT_PASSWORD=${{ secrets.TENCENT_PASSWORD }}
        TENCENT_URL=${{ secrets.TENCENT_URL }}
        TENCENT_SYNC_DAYS_PAST=${{ secrets.TENCENT_SYNC_DAYS_PAST || 90 }}
        TENCENT_SYNC_DAYS_FUTURE=${{ secrets.TENCENT_SYNC_DAYS_FUTURE || 90 }}
        EOF

    - name: åˆ—å‡ºé…ç½®çš„è´¦å·
      run: |
        echo "=== æ£€æŸ¥è´¦å·é…ç½® ==="
        python main.py --list

    - name: æ‰§è¡Œæ—¥å†åŒæ­¥
      run: |
        echo "=== å¼€å§‹æ—¥å†åŒæ­¥ ==="
        if [ "${{ github.event.inputs.sync_type }}" = "dingtalk" ]; then
          echo "åŒæ­¥é’‰é’‰è´¦å·..."
          python main.py --sync-type dingtalk
        elif [ "${{ github.event.inputs.sync_type }}" = "tencent" ]; then
          echo "åŒæ­¥è…¾è®¯ä¼šè®®è´¦å·..."
          python main.py --sync-type tencent
        else
          echo "åŒæ­¥æ‰€æœ‰è´¦å·..."
          python main.py --sync-all
        fi

    - name: åˆå¹¶ICSæ–‡ä»¶
      run: |
        echo "=== å¼€å§‹åˆå¹¶ICSæ–‡ä»¶ ==="
        # æŒ‰ç±»å‹åˆå¹¶
        python main.py --merge-type dingtalk || echo "é’‰é’‰åˆå¹¶å¤±è´¥æˆ–æ— æ•°æ®"
        python main.py --merge-type tencent || echo "è…¾è®¯ä¼šè®®åˆå¹¶å¤±è´¥æˆ–æ— æ•°æ®"

        # å…¨å±€åˆå¹¶
        python main.py --merge-all

    - name: æ¸…ç†ä¸´æ—¶æ–‡ä»¶
      run: |
        echo "=== æ¸…ç†ä¸´æ—¶æ–‡ä»¶ ==="
        CLEANUP_DAYS="${{ github.event.inputs.cleanup_days }}"
        if [ -z "$CLEANUP_DAYS" ]; then
          CLEANUP_DAYS=7
        fi
        python main.py --cleanup $CLEANUP_DAYS

    - name: æ£€æŸ¥ç”Ÿæˆçš„æ–‡ä»¶
      run: |
        echo "=== æ£€æŸ¥ç”Ÿæˆçš„æ–‡ä»¶ ==="
        echo "Public ç›®å½•å†…å®¹:"
        ls -la public/ || echo "public ç›®å½•ä¸ºç©ºæˆ–ä¸å­˜åœ¨"

        echo "äº‹ä»¶ç›®å½•:"
        ls -la *_events_* || echo "æ²¡æœ‰äº‹ä»¶ç›®å½•"

    - name: å‡†å¤‡ GitHub Pages å†…å®¹
      run: |
        echo "=== å‡†å¤‡ GitHub Pages å†…å®¹ ==="

        # åˆ›å»º GitHub Pages æ ¹ç›®å½•
        mkdir -p _site

        # å¤åˆ¶ public ç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶åˆ° _site
        if [ -d "public" ] && [ "$(ls -A public)" ]; then
          cp -r public/* _site/
          echo "å·²å¤åˆ¶ public ç›®å½•å†…å®¹åˆ° _site"
        else
          echo "public ç›®å½•ä¸ºç©ºï¼Œåˆ›å»ºé»˜è®¤é¡µé¢"
          echo "<h1>CalDAV åŒæ­¥å·¥å…·</h1><p>æš‚æ— æ—¥å†æ•°æ®</p>" > _site/index.html
        fi

        # ç”Ÿæˆæ–‡ä»¶åˆ—è¡¨ JSON
        echo "=== ç”Ÿæˆæ–‡ä»¶åˆ—è¡¨ JSON ==="
        python3 << 'PYTHON'
        import json
        import os
        import glob
        from datetime import datetime

        files_data = {
            "generated_at": datetime.utcnow().isoformat() + "Z",
            "calendar_files": []
        }

        # æ‰«æ public ç›®å½•ä¸‹çš„æ‰€æœ‰ .ics æ–‡ä»¶
        all_files = glob.glob("_site/*.ics")
        for file_path in all_files:
            filename = os.path.basename(file_path)
            file_size = os.path.getsize(file_path)
            file_mtime = os.path.getmtime(file_path)

            description = "æœªçŸ¥æ—¥å†"
            if filename.startswith("all_calendars_"):
                description = "åŒ…å«æ‰€æœ‰è´¦å·çš„åˆå¹¶æ—¥å†æ•°æ®"
            elif filename.startswith("dingtalk_"):
                description = "ä»…åŒ…å«é’‰é’‰æ—¥å†æ•°æ®"
            elif filename.startswith("tencent_"):
                description = "ä»…åŒ…å«è…¾è®¯ä¼šè®®æ—¥å†æ•°æ®"

            files_data["calendar_files"].append({
                "filename": filename,
                "size": file_size,
                "modified": datetime.fromtimestamp(file_mtime).isoformat() + "Z",
                "description": description
            })

        # æŒ‰æ–‡ä»¶åæ’åºï¼Œall_calendars å¼€å¤´çš„æ’åœ¨æœ€å‰é¢
        files_data["calendar_files"].sort(key=lambda x: (not x['filename'].startswith('all_calendars_'), x['filename']))

        # ä¿å­˜ JSON æ–‡ä»¶
        with open("_site/files.json", "w", encoding="utf-8") as f:
            json.dump(files_data, f, ensure_ascii=False, indent=2)

        print(f"âœ… ç”Ÿæˆæ–‡ä»¶åˆ—è¡¨: {len(files_data['calendar_files'])} ä¸ªæ—¥å†æ–‡ä»¶")
        PYTHON

        # åˆ›å»ºæ–°çš„ç´¢å¼•é¡µé¢
        cat > _site/index.html << 'EOF'
        <!DOCTYPE html>
        <html lang="zh-CN">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>CalDAV åŒæ­¥å·¥å…· - æ—¥å†æ–‡ä»¶</title>
            <style>
                * { box-sizing: border-box; }
                body {
                    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                    margin: 0;
                    padding: 20px;
                    background: #f0f2f5;
                    color: #333;
                }
                .container {
                    max-width: 900px;
                    margin: 20px auto;
                    background: white;
                    padding: 20px 40px;
                    border-radius: 12px;
                    box-shadow: 0 4px 20px rgba(0,0,0,0.08);
                }
                .header {
                    text-align: center;
                    margin-bottom: 30px;
                    padding-bottom: 20px;
                    border-bottom: 1px solid #e8e8e8;
                }
                h1 {
                    color: #1f1f1f;
                    margin: 0;
                    font-size: 2em;
                }
                .subtitle {
                    color: #595959;
                    font-size: 1em;
                    margin-top: 8px;
                }
                h2 {
                    color: #333;
                    margin: 30px 0 20px 0;
                    font-size: 1.3em;
                }
                .file-grid {
                    display: grid;
                    gap: 15px;
                }
                .file-card {
                    padding: 15px 20px;
                    background: #fafafa;
                    border-radius: 8px;
                    border: 1px solid #d9d9d9;
                    transition: all 0.2s ease-in-out;
                }
                .file-card:hover {
                    border-color: #40a9ff;
                    box-shadow: 0 2px 8px rgba(0,0,0,0.09);
                }
                .file-name a {
                    font-weight: 500;
                    font-size: 1.1em;
                    color: #1890ff;
                    text-decoration: none;
                }
                .file-name a:hover {
                    text-decoration: underline;
                }
                .description {
                    color: #595959;
                    margin: 5px 0 10px 0;
                    font-size: 0.9em;
                }
                .file-info {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    font-size: 0.85em;
                    color: #8c8c8c;
                }
                .empty-state {
                    text-align: center;
                    padding: 40px;
                    color: #8c8c8c;
                    background: #fafafa;
                    border-radius: 8px;
                }
                .footer {
                    margin-top: 30px;
                    padding-top: 20px;
                    border-top: 1px solid #e8e8e8;
                    text-align: center;
                    color: #8c8c8c;
                    font-size: 0.9em;
                }
            </style>
        </head>
        <body>
            <div class="container">
                <div class="header">
                    <h1>ğŸ“… CalDAV æ—¥å†æ–‡ä»¶</h1>
                    <div class="subtitle">ç”± CalDAV åŒæ­¥å·¥å…·è‡ªåŠ¨ç”Ÿæˆ</div>
                </div>

                <h2>æ‰€æœ‰æ—¥å†æ–‡ä»¶</h2>
                <div class="file-grid" id="calendar-files">
                    <div class="loading">æ­£åœ¨åŠ è½½æ–‡ä»¶åˆ—è¡¨...</div>
                </div>

                <div class="footer">
                    <p>æœ€åæ›´æ–°äº: <span id="update-time"></span></p>
                </div>
            </div>

            <script>
                function formatFileSize(bytes) {
                    if (bytes === 0) return '0 B';
                    const k = 1024;
                    const sizes = ['B', 'KB', 'MB', 'GB'];
                    const i = Math.floor(Math.log(bytes) / Math.log(k));
                    return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
                }

                function formatDate(dateString) {
                    const date = new Date(dateString);
                    return date.toLocaleString('zh-CN', { timeZone: 'Asia/Shanghai', hour12: false }).replace(/\//g, '-');
                }

                function createFileCard(file) {
                    return `
                        <div class="file-card">
                            <div class="file-name">
                                <a href="./${file.filename}" download>${file.filename}</a>
                            </div>
                            <div class="description">${file.description}</div>
                            <div class="file-info">
                                <span>${formatDate(file.modified)}</span>
                                <span>${formatFileSize(file.size)}</span>
                            </div>
                        </div>
                    `;
                }

                async function loadFileList() {
                    const container = document.getElementById('calendar-files');
                    try {
                        const response = await fetch('./files.json?cache_bust=' + new Date().getTime());
                        if (!response.ok) throw new Error('Network response was not ok');
                        const data = await response.json();

                        document.getElementById('update-time').textContent = formatDate(data.generated_at);

                        if (data.calendar_files && data.calendar_files.length > 0) {
                            container.innerHTML = data.calendar_files.map(createFileCard).join('');
                        } else {
                            container.innerHTML = '<div class="empty-state">æš‚æ— æ—¥å†æ–‡ä»¶ã€‚</div>';
                        }
                    } catch (error) {
                        console.error('åŠ è½½æ–‡ä»¶åˆ—è¡¨å¤±è´¥:', error);
                        container.innerHTML = '<div class="empty-state">æ— æ³•åŠ è½½æ–‡ä»¶åˆ—è¡¨ï¼Œè¯·ç¨åé‡è¯•ã€‚</div>';
                    }
                }

                document.addEventListener('DOMContentLoaded', loadFileList);
            </script>
        </body>
        </html>
        EOF

        echo "GitHub Pages å†…å®¹å‡†å¤‡å®Œæˆ"
        ls -la _site/

    - name: è®¾ç½® GitHub Pages
      uses: actions/configure-pages@v5

    - name: ä¸Šä¼  GitHub Pages å†…å®¹
      uses: actions/upload-pages-artifact@v3
      with:
        path: '_site'

    - name: éƒ¨ç½²åˆ° GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4

    - name: è¾“å‡ºéƒ¨ç½²ç»“æœ
      run: |
        echo "=== éƒ¨ç½²å®Œæˆ ==="
        echo "GitHub Pages URL: ${{ steps.deployment.outputs.page_url }}"
        echo "éƒ¨ç½²çŠ¶æ€: æˆåŠŸ"

        # æ˜¾ç¤ºæœ€ç»ˆçš„æ–‡ä»¶ç»Ÿè®¡
        echo "=== æ–‡ä»¶ç»Ÿè®¡ ==="
        echo "Public æ–‡ä»¶æ•°é‡: $(find _site -name '*.ics' | wc -l)"
        echo "æ€»æ–‡ä»¶å¤§å°: $(du -sh _site | cut -f1)"
