name: GitHub Pages é…ç½®

on:
  # å½“æ¨é€åˆ° main åˆ†æ”¯ä¸”åŒ…å« public ç›®å½•å˜æ›´æ—¶è§¦å‘
  push:
    branches: [ main ]
    paths:
      - 'public/**'
      - 'merged/**'
      - '.github/workflows/pages.yml'

  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

# è®¾ç½® GITHUB_TOKEN çš„æƒé™ä»¥å…è®¸éƒ¨ç½²åˆ° GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

# åªå…è®¸ä¸€ä¸ªå¹¶å‘éƒ¨ç½²ï¼Œè·³è¿‡æ­£åœ¨è¿è¡Œå’Œæœ€æ–°é˜Ÿåˆ—ä¹‹é—´çš„è¿è¡Œé˜Ÿåˆ—
# ä½†æ˜¯ï¼Œä¸è¦å–æ¶ˆæ­£åœ¨è¿›è¡Œçš„è¿è¡Œï¼Œå› ä¸ºæˆ‘ä»¬å¸Œæœ›è®©è¿™äº›ç”Ÿäº§éƒ¨ç½²å®Œæˆ
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  # æ„å»ºä½œä¸š
  build:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® GitHub Pages
        uses: actions/configure-pages@v3

      - name: æ„å»º GitHub Pages å†…å®¹
        run: |
          echo "=== æ„å»º GitHub Pages å†…å®¹ ==="

          # åˆ›å»ºæ„å»ºç›®å½•
          mkdir -p _site

          # å¤åˆ¶ public ç›®å½•å†…å®¹
          if [ -d "public" ] && [ "$(ls -A public)" ]; then
            cp -r public/* _site/
            echo "âœ… å·²å¤åˆ¶ public ç›®å½•å†…å®¹"
          else
            echo "âš ï¸ public ç›®å½•ä¸ºç©ºæˆ–ä¸å­˜åœ¨"
          fi

          # å¤åˆ¶ merged ç›®å½•å†…å®¹
          if [ -d "merged" ] && [ "$(ls -A merged)" ]; then
            mkdir -p _site/merged
            cp -r merged/* _site/merged/
            echo "âœ… å·²å¤åˆ¶ merged ç›®å½•å†…å®¹"
          else
            echo "âš ï¸ merged ç›®å½•ä¸ºç©ºæˆ–ä¸å­˜åœ¨"
          fi

          # ç”Ÿæˆæ–‡ä»¶åˆ—è¡¨ JSON
          echo "=== ç”Ÿæˆæ–‡ä»¶åˆ—è¡¨ ==="
          cat > _site/files.json << 'EOF'
          {
            "generated_at": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
            "calendar_files": [],
            "merged_files": []
          }
          EOF

          # æ‰«æ .ics æ–‡ä»¶å¹¶æ›´æ–° JSON
          python3 << 'PYTHON'
          import json
          import os
          import glob
          from datetime import datetime

          files_data = {
              "generated_at": datetime.utcnow().isoformat() + "Z",
              "calendar_files": [],
              "merged_files": []
          }

          # æ‰«æå…¨å±€åˆå¹¶æ–‡ä»¶
          calendar_files = glob.glob("_site/all_calendars_*.ics")
          for file_path in calendar_files:
              filename = os.path.basename(file_path)
              file_size = os.path.getsize(file_path)
              file_mtime = os.path.getmtime(file_path)

              files_data["calendar_files"].append({
                  "filename": filename,
                  "size": file_size,
                  "modified": datetime.fromtimestamp(file_mtime).isoformat() + "Z",
                  "description": "åŒ…å«æ‰€æœ‰è´¦å·çš„åˆå¹¶æ—¥å†æ•°æ®"
              })

          # æ‰«ææŒ‰ç±»å‹åˆå¹¶çš„æ–‡ä»¶
          if os.path.exists("_site/merged"):
              merged_files = glob.glob("_site/merged/*.ics")
              for file_path in merged_files:
                  filename = os.path.basename(file_path)
                  file_size = os.path.getsize(file_path)
                  file_mtime = os.path.getmtime(file_path)

                  # æ ¹æ®æ–‡ä»¶ååˆ¤æ–­ç±»å‹
                  if "dingtalk" in filename.lower():
                      description = "é’‰é’‰æ—¥å†æ•°æ®"
                  elif "tencent" in filename.lower():
                      description = "è…¾è®¯ä¼šè®®æ—¥å†æ•°æ®"
                  else:
                      description = "æ—¥å†æ•°æ®"

                  files_data["merged_files"].append({
                      "filename": f"merged/{filename}",
                      "size": file_size,
                      "modified": datetime.fromtimestamp(file_mtime).isoformat() + "Z",
                      "description": description
                  })

          # ä¿å­˜ JSON æ–‡ä»¶
          with open("_site/files.json", "w", encoding="utf-8") as f:
              json.dump(files_data, f, ensure_ascii=False, indent=2)

          print(f"âœ… ç”Ÿæˆæ–‡ä»¶åˆ—è¡¨: {len(files_data['calendar_files'])} ä¸ªå…¨å±€æ–‡ä»¶, {len(files_data['merged_files'])} ä¸ªåˆ†ç±»æ–‡ä»¶")
          PYTHON

          # åˆ›å»ºæ”¹è¿›çš„ç´¢å¼•é¡µé¢
          cat > _site/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="zh-CN">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>CalDAV åŒæ­¥å·¥å…· - æ—¥å†æ–‡ä»¶</title>
              <style>
                  * { box-sizing: border-box; }
                  body {
                      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                      margin: 0;
                      padding: 20px;
                      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                      min-height: 100vh;
                      color: #333;
                  }
                  .container {
                      max-width: 1000px;
                      margin: 0 auto;
                      background: white;
                      padding: 40px;
                      border-radius: 15px;
                      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
                  }
                  .header {
                      text-align: center;
                      margin-bottom: 40px;
                      padding-bottom: 20px;
                      border-bottom: 2px solid #eee;
                  }
                  h1 {
                      color: #2c3e50;
                      margin: 0;
                      font-size: 2.5em;
                      font-weight: 300;
                  }
                  .subtitle {
                      color: #7f8c8d;
                      font-size: 1.1em;
                      margin-top: 10px;
                  }
                  h2 {
                      color: #34495e;
                      margin: 30px 0 20px 0;
                      font-size: 1.5em;
                      display: flex;
                      align-items: center;
                  }
                  h2::before {
                      content: '';
                      width: 4px;
                      height: 24px;
                      background: #3498db;
                      margin-right: 12px;
                      border-radius: 2px;
                  }
                  .file-grid {
                      display: grid;
                      gap: 20px;
                      margin-bottom: 30px;
                  }
                  .file-card {
                      padding: 20px;
                      background: #f8f9fa;
                      border-radius: 10px;
                      border: 1px solid #e9ecef;
                      transition: all 0.3s ease;
                      position: relative;
                      overflow: hidden;
                  }
                  .file-card::before {
                      content: '';
                      position: absolute;
                      top: 0;
                      left: 0;
                      width: 100%;
                      height: 4px;
                      background: linear-gradient(90deg, #3498db, #2ecc71);
                  }
                  .file-card:hover {
                      background: #fff;
                      transform: translateY(-2px);
                      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
                  }
                  .file-name {
                      font-weight: 600;
                      font-size: 1.1em;
                      color: #2980b9;
                      margin-bottom: 8px;
                  }
                  .file-name a {
                      color: inherit;
                      text-decoration: none;
                  }
                  .file-name a:hover {
                      text-decoration: underline;
                  }
                  .file-info {
                      display: flex;
                      justify-content: space-between;
                      align-items: center;
                      margin-top: 12px;
                      font-size: 0.9em;
                      color: #7f8c8d;
                  }
                  .file-size {
                      background: #ecf0f1;
                      padding: 4px 8px;
                      border-radius: 12px;
                      font-size: 0.8em;
                  }
                  .description {
                      color: #555;
                      margin-top: 8px;
                      font-size: 0.95em;
                      line-height: 1.4;
                  }
                  .empty-state {
                      text-align: center;
                      padding: 60px 20px;
                      color: #7f8c8d;
                      background: #f8f9fa;
                      border-radius: 10px;
                      border: 2px dashed #bdc3c7;
                  }
                  .empty-state-icon {
                      font-size: 3em;
                      margin-bottom: 20px;
                  }
                  .footer {
                      margin-top: 40px;
                      padding-top: 20px;
                      border-top: 1px solid #eee;
                      text-align: center;
                      color: #7f8c8d;
                  }
                  .github-link {
                      display: inline-block;
                      margin-top: 15px;
                      padding: 12px 24px;
                      background: #333;
                      color: white;
                      text-decoration: none;
                      border-radius: 25px;
                      transition: all 0.3s ease;
                      font-weight: 500;
                  }
                  .github-link:hover {
                      background: #555;
                      transform: translateY(-1px);
                      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                  }
                  .loading {
                      text-align: center;
                      padding: 20px;
                      color: #7f8c8d;
                  }
                  .spinner {
                      border: 3px solid #f3f3f3;
                      border-top: 3px solid #3498db;
                      border-radius: 50%;
                      width: 30px;
                      height: 30px;
                      animation: spin 1s linear infinite;
                      margin: 0 auto 15px;
                  }
                  @keyframes spin {
                      0% { transform: rotate(0deg); }
                      100% { transform: rotate(360deg); }
                  }
                  @media (max-width: 768px) {
                      .container { padding: 20px; margin: 10px; }
                      h1 { font-size: 2em; }
                      .file-info { flex-direction: column; align-items: flex-start; gap: 8px; }
                  }
              </style>
          </head>
          <body>
              <div class="container">
                  <div class="header">
                      <h1>ğŸ“… CalDAV åŒæ­¥å·¥å…·</h1>
                      <div class="subtitle">è‡ªåŠ¨åŒæ­¥é’‰é’‰å’Œè…¾è®¯ä¼šè®®çš„æ—¥å†æ•°æ®</div>
                  </div>

                  <h2>ğŸŒ å…¨å±€åˆå¹¶æ—¥å†æ–‡ä»¶</h2>
                  <div class="file-grid" id="calendar-files">
                      <div class="loading">
                          <div class="spinner"></div>
                          æ­£åœ¨åŠ è½½æ–‡ä»¶åˆ—è¡¨...
                      </div>
                  </div>

                  <h2>ğŸ“‹ æŒ‰ç±»å‹åˆ†ç±»çš„æ—¥å†æ–‡ä»¶</h2>
                  <div class="file-grid" id="merged-files">
                      <div class="loading">
                          <div class="spinner"></div>
                          æ­£åœ¨åŠ è½½æ–‡ä»¶åˆ—è¡¨...
                      </div>
                  </div>

                  <div class="footer">
                      <p><strong>æœ€åæ›´æ–°æ—¶é—´:</strong> <span id="update-time"></span></p>
                      <p>ç”± GitHub Actions è‡ªåŠ¨ç”Ÿæˆå’Œéƒ¨ç½²</p>
                      <a href="https://github.com/your-username/sync-caldav-v3" class="github-link" target="_blank">
                          ğŸ“‚ æŸ¥çœ‹æºä»£ç 
                      </a>
                  </div>
              </div>

              <script>
                  // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
                  function formatFileSize(bytes) {
                      if (bytes === 0) return '0 B';
                      const k = 1024;
                      const sizes = ['B', 'KB', 'MB', 'GB'];
                      const i = Math.floor(Math.log(bytes) / Math.log(k));
                      return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
                  }

                  // æ ¼å¼åŒ–æ—¥æœŸ
                  function formatDate(dateString) {
                      const date = new Date(dateString);
                      return date.toLocaleString('zh-CN', {
                          year: 'numeric',
                          month: '2-digit',
                          day: '2-digit',
                          hour: '2-digit',
                          minute: '2-digit'
                      });
                  }

                  // åˆ›å»ºæ–‡ä»¶å¡ç‰‡
                  function createFileCard(file) {
                      return `
                          <div class="file-card">
                              <div class="file-name">
                                  <a href="./${file.filename}" download>${file.filename}</a>
                              </div>
                              <div class="description">${file.description}</div>
                              <div class="file-info">
                                  <span>ä¿®æ”¹æ—¶é—´: ${formatDate(file.modified)}</span>
                                  <span class="file-size">${formatFileSize(file.size)}</span>
                              </div>
                          </div>
                      `;
                  }

                  // åˆ›å»ºç©ºçŠ¶æ€
                  function createEmptyState(message, icon = 'ğŸ“„') {
                      return `
                          <div class="empty-state">
                              <div class="empty-state-icon">${icon}</div>
                              <p>${message}</p>
                          </div>
                      `;
                  }

                  // åŠ è½½æ–‡ä»¶åˆ—è¡¨
                  async function loadFileList() {
                      try {
                          const response = await fetch('./files.json');
                          const data = await response.json();

                          const calendarFiles = document.getElementById('calendar-files');
                          const mergedFiles = document.getElementById('merged-files');

                          // æ›´æ–°æ—¶é—´
                          document.getElementById('update-time').textContent = formatDate(data.generated_at);

                          // æ˜¾ç¤ºå…¨å±€åˆå¹¶æ–‡ä»¶
                          if (data.calendar_files && data.calendar_files.length > 0) {
                              calendarFiles.innerHTML = data.calendar_files.map(createFileCard).join('');
                          } else {
                              calendarFiles.innerHTML = createEmptyState(
                                  'æš‚æ— å…¨å±€åˆå¹¶çš„æ—¥å†æ–‡ä»¶<br>è¯·è¿è¡ŒåŒæ­¥å·¥ä½œæµç”Ÿæˆæ—¥å†æ•°æ®',
                                  'ğŸŒ'
                              );
                          }

                          // æ˜¾ç¤ºåˆ†ç±»æ–‡ä»¶
                          if (data.merged_files && data.merged_files.length > 0) {
                              mergedFiles.innerHTML = data.merged_files.map(createFileCard).join('');
                          } else {
                              mergedFiles.innerHTML = createEmptyState(
                                  'æš‚æ— æŒ‰ç±»å‹åˆ†ç±»çš„æ—¥å†æ–‡ä»¶<br>è¯·è¿è¡ŒåŒæ­¥å·¥ä½œæµç”Ÿæˆæ—¥å†æ•°æ®',
                                  'ğŸ“‹'
                              );
                          }

                      } catch (error) {
                          console.error('åŠ è½½æ–‡ä»¶åˆ—è¡¨å¤±è´¥:', error);

                          // æ˜¾ç¤ºé”™è¯¯çŠ¶æ€
                          document.getElementById('calendar-files').innerHTML = createEmptyState(
                              'æ— æ³•åŠ è½½æ–‡ä»¶åˆ—è¡¨<br>è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–ç¨åé‡è¯•',
                              'âš ï¸'
                          );
                          document.getElementById('merged-files').innerHTML = createEmptyState(
                              'æ— æ³•åŠ è½½æ–‡ä»¶åˆ—è¡¨<br>è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–ç¨åé‡è¯•',
                              'âš ï¸'
                          );

                          // è®¾ç½®å½“å‰æ—¶é—´
                          document.getElementById('update-time').textContent = new Date().toLocaleString('zh-CN');
                      }
                  }

                  // é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œ
                  document.addEventListener('DOMContentLoaded', loadFileList);
              </script>
          </body>
          </html>
          EOF

          echo "âœ… æ„å»ºå®Œæˆ"
          echo "æ–‡ä»¶åˆ—è¡¨:"
          ls -la _site/

      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-pages-artifact@v2
        with:
          path: '_site'

  # éƒ¨ç½²ä½œä¸š
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: éƒ¨ç½²åˆ° GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v2
