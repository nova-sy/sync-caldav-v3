name: ä»…éƒ¨ç½² GitHub Pages

on:
  # æ‰‹åŠ¨è§¦å‘ - ä»…éƒ¨ç½²ç°æœ‰çš„ public æ–‡ä»¶åˆ° GitHub Pages
  workflow_dispatch:
    inputs:
      message:
        description: 'éƒ¨ç½²è¯´æ˜'
        required: false
        default: 'æ‰‹åŠ¨éƒ¨ç½²ç°æœ‰æ–‡ä»¶'
        type: string

jobs:
  deploy-only:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      pages: write
      id-token: write

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: æ£€æŸ¥ç°æœ‰æ–‡ä»¶
      run: |
        echo "=== æ£€æŸ¥ç°æœ‰æ–‡ä»¶ ==="
        echo "Public ç›®å½•å†…å®¹:"
        ls -la public/ || echo "public ç›®å½•ä¸ºç©ºæˆ–ä¸å­˜åœ¨"

        echo "Merged ç›®å½•å†…å®¹:"
        ls -la merged/ || echo "merged ç›®å½•ä¸ºç©ºæˆ–ä¸å­˜åœ¨"

    - name: å‡†å¤‡ GitHub Pages å†…å®¹
      run: |
        echo "=== å‡†å¤‡ GitHub Pages å†…å®¹ ==="
        echo "éƒ¨ç½²è¯´æ˜: ${{ github.event.inputs.message }}"

        # åˆ›å»º GitHub Pages æ ¹ç›®å½•
        mkdir -p _site

        # å¤åˆ¶ public ç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶åˆ° _site
        if [ -d "public" ] && [ "$(ls -A public)" ]; then
          cp -r public/* _site/
          echo "å·²å¤åˆ¶ public ç›®å½•å†…å®¹åˆ° _site"
        else
          echo "public ç›®å½•ä¸ºç©ºï¼Œåˆ›å»ºé»˜è®¤é¡µé¢"
        fi

        # å¤åˆ¶ merged ç›®å½•åˆ° _site/mergedï¼ˆå¯é€‰ï¼‰
        if [ -d "merged" ] && [ "$(ls -A merged)" ]; then
          mkdir -p _site/merged
          cp -r merged/* _site/merged/
          echo "å·²å¤åˆ¶ merged ç›®å½•å†…å®¹"
        fi

        # åˆ›å»ºæˆ–æ›´æ–°ç´¢å¼•é¡µé¢
        cat > _site/index.html << 'EOF'
        <!DOCTYPE html>
        <html lang="zh-CN">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>CalDAV åŒæ­¥å·¥å…· - æ—¥å†æ–‡ä»¶</title>
            <style>
                body {
                    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                    margin: 0;
                    padding: 40px;
                    background: #f8f9fa;
                    color: #333;
                }
                .container {
                    max-width: 900px;
                    margin: 0 auto;
                    background: white;
                    padding: 40px;
                    border-radius: 10px;
                    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                }
                h1 { color: #2c3e50; border-bottom: 3px solid #3498db; padding-bottom: 10px; }
                h2 { color: #34495e; margin-top: 30px; }
                .file-list { list-style: none; padding: 0; }
                .file-list li {
                    margin: 15px 0;
                    padding: 15px;
                    background: #f8f9fa;
                    border-radius: 8px;
                    border-left: 4px solid #3498db;
                    transition: all 0.3s ease;
                }
                .file-list li:hover {
                    background: #e9ecef;
                    transform: translateX(5px);
                }
                .file-list a {
                    text-decoration: none;
                    color: #2980b9;
                    font-weight: 600;
                    font-size: 1.1em;
                }
                .file-list a:hover { text-decoration: underline; }
                .timestamp {
                    color: #7f8c8d;
                    font-size: 0.9em;
                    background: #ecf0f1;
                    padding: 15px;
                    border-radius: 5px;
                    margin-top: 30px;
                }
                .description { color: #555; margin-top: 8px; font-size: 0.95em; }
                .status {
                    display: inline-block;
                    padding: 4px 12px;
                    background: #27ae60;
                    color: white;
                    border-radius: 20px;
                    font-size: 0.8em;
                    margin-left: 10px;
                }
                .empty-state {
                    text-align: center;
                    padding: 40px;
                    color: #7f8c8d;
                    font-style: italic;
                }
                .github-link {
                    display: inline-block;
                    margin-top: 20px;
                    padding: 10px 20px;
                    background: #333;
                    color: white;
                    text-decoration: none;
                    border-radius: 5px;
                    transition: background 0.3s ease;
                }
                .github-link:hover {
                    background: #555;
                    color: white;
                    text-decoration: none;
                }
            </style>
        </head>
        <body>
            <div class="container">
                <h1>ğŸ“… CalDAV åŒæ­¥å·¥å…· - æ—¥å†æ–‡ä»¶</h1>
                <p>è¿™é‡Œæ˜¯è‡ªåŠ¨åŒæ­¥çš„æ—¥å†æ–‡ä»¶ï¼ŒåŒ…å«é’‰é’‰å’Œè…¾è®¯ä¼šè®®çš„æ—¥å†æ•°æ®ã€‚</p>

                <h2>ğŸŒ å…¨å±€åˆå¹¶æ—¥å†æ–‡ä»¶</h2>
                <ul class="file-list" id="calendar-files">
                    <li class="empty-state">æ­£åœ¨æ£€æŸ¥æ–‡ä»¶...</li>
                </ul>

                <h2>ğŸ“‹ æŒ‰ç±»å‹åˆ†ç±»çš„æ—¥å†æ–‡ä»¶</h2>
                <ul class="file-list" id="merged-files">
                    <li class="empty-state">æ­£åœ¨æ£€æŸ¥æ–‡ä»¶...</li>
                </ul>

                <div class="timestamp">
                    <p><strong>æœ€åæ›´æ–°æ—¶é—´:</strong> <span id="update-time"></span></p>
                    <p><strong>éƒ¨ç½²æ–¹å¼:</strong> GitHub Actions è‡ªåŠ¨éƒ¨ç½²</p>
                    <a href="https://github.com/your-username/sync-caldav-v3" class="github-link" target="_blank">
                        ğŸ“‚ æŸ¥çœ‹æºä»£ç 
                    </a>
                </div>
            </div>

            <script>
                // è®¾ç½®æ›´æ–°æ—¶é—´
                document.getElementById('update-time').textContent = new Date().toLocaleString('zh-CN', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });

                // æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨çš„å‡½æ•°
                async function checkFileExists(filename) {
                    try {
                        const response = await fetch(filename, { method: 'HEAD' });
                        return response.ok;
                    } catch {
                        return false;
                    }
                }

                // åŠ¨æ€åŠ è½½æ–‡ä»¶åˆ—è¡¨
                async function loadFileList() {
                    const calendarFiles = document.getElementById('calendar-files');
                    const mergedFiles = document.getElementById('merged-files');

                    // æ¸…ç©ºåŠ è½½çŠ¶æ€
                    calendarFiles.innerHTML = '';
                    mergedFiles.innerHTML = '';

                    let foundCalendarFiles = false;
                    let foundMergedFiles = false;

                    // æ£€æŸ¥å¸¸è§çš„æ–‡ä»¶æ¨¡å¼
                    const today = new Date();
                    const dateStr = today.getFullYear() +
                        String(today.getMonth() + 1).padStart(2, '0') +
                        String(today.getDate()).padStart(2, '0');

                    // æ£€æŸ¥å…¨å±€åˆå¹¶æ–‡ä»¶
                    const possibleCalendarFiles = [
                        `all_calendars_${dateStr}_*.ics`,
                        'all_calendars_latest.ics'
                    ];

                    // æ£€æŸ¥æŒ‰ç±»å‹åˆå¹¶çš„æ–‡ä»¶
                    const possibleMergedFiles = [
                        `dingtalk_merged_${dateStr}_*.ics`,
                        `tencent_merged_${dateStr}_*.ics`,
                        'dingtalk_merged_latest.ics',
                        'tencent_merged_latest.ics'
                    ];

                    // ç”±äºæ— æ³•ç›´æ¥åˆ—å‡ºç›®å½•ï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªé€šç”¨çš„æ–‡ä»¶æ£€æŸ¥é€»è¾‘
                    // å®é™…éƒ¨ç½²æ—¶ï¼Œå¯ä»¥é€šè¿‡æœåŠ¡å™¨ç«¯è„šæœ¬æˆ–æ„å»ºæ—¶ç”Ÿæˆæ–‡ä»¶åˆ—è¡¨

                    if (!foundCalendarFiles) {
                        calendarFiles.innerHTML = `
                            <li class="empty-state">
                                æš‚æ— å…¨å±€åˆå¹¶çš„æ—¥å†æ–‡ä»¶ã€‚<br>
                                è¯·è¿è¡ŒåŒæ­¥å·¥ä½œæµç”Ÿæˆæ—¥å†æ•°æ®ã€‚
                            </li>
                        `;
                    }

                    if (!foundMergedFiles) {
                        mergedFiles.innerHTML = `
                            <li class="empty-state">
                                æš‚æ— æŒ‰ç±»å‹åˆ†ç±»çš„æ—¥å†æ–‡ä»¶ã€‚<br>
                                è¯·è¿è¡ŒåŒæ­¥å·¥ä½œæµç”Ÿæˆæ—¥å†æ•°æ®ã€‚
                            </li>
                        `;
                    }
                }

                // é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œ
                document.addEventListener('DOMContentLoaded', loadFileList);
            </script>
        </body>
        </html>
        EOF

        echo "GitHub Pages å†…å®¹å‡†å¤‡å®Œæˆ"
        ls -la _site/

    - name: è®¾ç½® GitHub Pages
      uses: actions/configure-pages@v3

    - name: ä¸Šä¼  GitHub Pages å†…å®¹
      uses: actions/upload-pages-artifact@v2
      with:
        path: '_site'

    - name: éƒ¨ç½²åˆ° GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v2

    - name: è¾“å‡ºéƒ¨ç½²ç»“æœ
      run: |
        echo "=== éƒ¨ç½²å®Œæˆ ==="
        echo "GitHub Pages URL: ${{ steps.deployment.outputs.page_url }}"
        echo "éƒ¨ç½²è¯´æ˜: ${{ github.event.inputs.message }}"
        echo "éƒ¨ç½²çŠ¶æ€: æˆåŠŸ"
